// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

/**
 * Model: User
 * Representa um usuário da plataforma
 * 
 * Um usuário pode criar/participar de múltiplas campanhas,
// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

/**
 * Model: User
 * Representa um usuário da plataforma
 * 
 * Um usuário pode criar/participar de múltiplas campanhas,
 * ter múltiplos personagens e logar na plataforma.
 */
model User {
  id        String   @id @default(uuid())
  email     String   @unique
  username  String   @unique
  password  String
  avatar    String?
  bio       String?  // Biografia curta
  timezone  String   @default("America/Sao_Paulo")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relacionamentos
  campaigns       CampaignMember[]
  characters      Character[]
  messages        Message[]
}

// ===== CAMPANHAS =====

model Campaign {
  id          String   @id @default(uuid())
  name        String
  description String?
  coverImage  String?  // URL da imagem de capa
  system      String   @default("Ordem Paranormal") // Sistema de RPG
  status      String   @default("ACTIVE") // ACTIVE, PAUSED, ENDED
  
  // Configurações do criador (Steps 2-3)
  items       Json?    // Adquiríveis: [{ title, properties: [{name, description}] }]
  abilities   Json?    // Habilidades: [{ title, properties }]
  npcs        Json?    // NPCs: [{ name, bars: [{title, type}], properties }]
  creatures   Json?    // Criaturas: mesma estrutura de NPCs
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relacionamentos
  members     CampaignMember[]
  characters  Character[]
  invites     Invite[]
  sessions    Session[]
}

model CampaignMember {
  id         String   @id @default(uuid())
  campaignId String
  userId     String
  role       String   // MASTER, PLAYER, OBSERVER
  joinedAt   DateTime @default(now())
  
  campaign   Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([campaignId, userId])
}

model Invite {
  id         String    @id @default(uuid())
  campaignId String
  token      String    @unique
  expiresAt  DateTime?
  usedBy     String[]  @default([]) // Array de userIds que usaram
  createdAt  DateTime  @default(now())
  
  campaign   Campaign  @relation(fields: [campaignId], references: [id], onDelete: Cascade)
}

// ===== PERSONAGENS =====

model Character {
  id          String   @id @default(uuid())
  campaignId  String
  userId      String
  name        String
  avatar      String?
  class       String   // Combatente, Especialista, Ocultista
  
  // Atributos (Ordem Paranormal)
  agilidade   Int      @default(0)
  forca       Int      @default(0)
  intelecto   Int      @default(0)
  presenca    Int      @default(0)
  vigor       Int      @default(0)
  
  // Recursos
  pv          Int      @default(0)
  pvMax       Int      @default(0)
  san         Int      @default(0)
  sanMax      Int      @default(0)
  pe          Int      @default(0)
  peMax       Int      @default(0)
  nex         Int      @default(5)
  
  // Outros dados
  defesa      Int      @default(10)
  movimento   Int      @default(9)
  pericias    Json?    // { "Atletismo": "Treinado", ... }
  inventory   Json?
  combat      Json?
  rituais     Json?
  afinidade   String?
  condicoes   Json?
  customData  Json?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  campaign    Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ===== SESSÕES =====

model Session {
  id         String    @id @default(uuid())
  campaignId String
  startedAt  DateTime  @default(now())
  endedAt    DateTime?
  
  campaign   Campaign  @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  messages   Message[]
}

model Message {
  id        String   @id @default(uuid())
  sessionId String
  userId    String
  content   String
  type      String   // TEXT, DICE_ROLL, NARRATION
  createdAt DateTime @default(now())
  
  session   Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}
